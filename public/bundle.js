(()=>{"use strict";const e=new class{constructor(){this.routes=[],this.currentView=null,this.isInitialized=!1,this.handleRouteChange=this.handleRouteChange.bind(this),this.handleLinkClick=this.handleLinkClick.bind(this)}addRoute(e,t,s){this.routes.push({path:e,view:t,title:s})}init(){this.isInitialized||(window.addEventListener("popstate",this.handleRouteChange),document.addEventListener("click",this.handleLinkClick),this.handleRouteChange(),this.isInitialized=!0,console.log("Router initialized"))}async handleRouteChange(){const e=window.location.pathname;await this.navigate(e,!1)}handleLinkClick(e){const t=e.target.closest("a[href]");if(!t)return;const s=t.getAttribute("href");!s||s.startsWith("http")||s.startsWith("mailto:")||s.startsWith("tel:")||s.startsWith("#")||(t.hasAttribute("data-router-ignore")?console.log("Ignoring link with data-router-ignore:",s):(e.preventDefault(),this.navigate(s)))}async navigate(e,t=!0){const s="/"===e?"/":`/${e.replace(/^\/+/,"")}`;t&&window.history.pushState({},"",s);const r=this.findRoute(s);r?await this.renderView(r,s):await this.show404()}findRoute(e){console.log(`[Router] Finding route for: ${e}`);const t=this.routes.find(t=>t.path===e);if(t)return console.log(`[Router] Exact match found: ${t.path}`),t;for(const t of this.routes)if(t.path.includes(":")){const s=this.pathToRegex(t.path);if(e.match(s))return console.log(`[Router] Pattern match found: ${t.path} for ${e}`),t}return console.log(`[Router] No route found for: ${e}`),null}extractParams(e,t){const s={},r=e.split("/"),n=t.split("/");for(let e=0;e<r.length;e++)r[e].startsWith(":")&&(s[r[e].slice(1)]=n[e]);return s}pathToRegex(e){const t=e.replace(/:\w+/g,"([^/]+)");return new RegExp(`^${t}$`)}async renderView(e,t){this.currentView&&"function"==typeof this.currentView.destroy&&this.currentView.destroy(),e.title&&(document.title=e.title);try{const s=e.view;let r={};t&&e.path.includes(":")&&(r=this.extractParams(e.path,t));const n=document.getElementById("root");if(n&&(this.currentView=new s(n,r),n.innerHTML="","function"==typeof this.currentView.render)){const e=await this.currentView.render();n.appendChild(e)}console.log(`Rendered view for route: ${e.path}`,r)}catch(e){console.error("Error rendering view:",e),await this.show404()}}async show404(){const e=document.getElementById("root");e&&(e.innerHTML='\n            <div style="text-align: center; padding: 50px;">\n            <h1>404 - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h1>\n            <p>–ó–∞–ø—Ä–æ—à–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.</p>\n            <a href="/" data-router-link>–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>\n            </div>\n        ')}destroy(){window.removeEventListener("popstate",this.handleRouteChange),document.removeEventListener("click",this.handleLinkClick),this.currentView&&"function"==typeof this.currentView.destroy&&this.currentView.destroy(),this.isInitialized=!1}},t=new class{async request(e,t={}){try{const s=`https://mindleak.ru/api${e}`;console.log(`AJAX Making request to: ${s}`,t);const r=await fetch(s,{headers:{"Content-Type":"application/json",...t.headers},credentials:"include",...t}),n=r.headers.get("content-type");let i=null;if(n&&n.includes("application/json"))try{i=await r.json()}catch(t){console.warn(`AJAX Failed to parse JSON from ${e}:`,t)}const o={status:r.status,data:i,message:r.statusText};return console.log(`AJAX Response from ${e}:`,o),o}catch(t){return console.error(`AJAX Network error for ${e}:`,t),{status:0,message:"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º üò≠"}}}async get(e){return this.request(e)}async post(e,t){return this.request(e,{method:"POST",body:t?JSON.stringify(t):void 0})}async getMe(){return this.get("/me")}async login(e){return this.post("/login",e)}async register(e){return this.post("/registration",e)}async logout(){return this.get("/logout")}async getFeed(){return this.get("/feed")}},s=200,r=401,n=new class{handleAction(e,t){switch(console.log(`API action: ${e}`,t),e){case"LOGIN_CHECK_REQUEST":this.checkAuth();break;case"LOGIN_REQUEST":this.login(t.email,t.password);break;case"LOGOUT_REQUEST":this.logout();break;case"SIGNUP_REQUEST":this.signUp(t.name,t.email,t.password);break;case"POSTS_LOAD_REQUEST":this.loadPosts();break;case"PROFILE_LOAD_REQUEST":this.loadProfile(t.userId);break;case"PROFILE_UPDATE_DESCRIPTION_REQUEST":this.updateProfileDescription(t.description)}}sendAction(e,t){o.dispatch(e,t)}async checkAuth(){const e=await t.getMe();switch(e.status){case s:if(e.data){const t={name:e.data.name,avatar:e.data.avatar||"/img/defaultAvatar.jpg",subtitle:e.data.subtitle||"–ë–ª–æ–≥"};this.sendAction("USER_LOGIN_CHECKED",{user:t})}else this.sendAction("USER_LOGIN_FAIL",{error:"No user data"});break;case r:this.sendAction("USER_LOGIN_FAIL",{error:"Not authenticated"});break;default:this.sendAction("USER_LOGIN_FAIL",{error:e.message||"Auth check failed"})}}async login(e,n){const i=await t.login({email:e,password:n});switch(i.status){case s:if(i.data){const e={name:i.data.name,avatar:i.data.avatar||"/img/defaultAvatar.jpg",subtitle:i.data.subtitle||"–ë–ª–æ–≥"};this.sendAction("USER_LOGIN_SUCCESS",{user:e})}else this.sendAction("USER_LOGIN_FAIL",{error:"No user data in response"});break;case r:case 400:case 404:this.sendAction("USER_LOGIN_FAIL",{error:"Email –∏–ª–∏ –ø–∞—Ä–æ–ª—å —É–∫–∞–∑–∞–Ω—ã –Ω–µ–≤–µ—Ä–Ω–æ"});break;default:this.sendAction("USER_LOGIN_FAIL",{error:i.data?.error||i.message||"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"})}}async logout(){(await t.logout()).status===s?this.sendAction("USER_LOGOUT"):this.sendAction("USER_LOGOUT_FAIL",{error:"Logout failed"})}async signUp(e,r,n){const i=await t.register({name:e,email:r,password:n});switch(i.status){case s:case 201:this.sendAction("USER_SIGNUP_SUCCESS");break;case 409:this.sendAction("USER_SIGNUP_FAIL",{error:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω"});break;default:this.sendAction("USER_SIGNUP_FAIL",{error:i.data?.globalError||i.message||"–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"})}}async loadPosts(){const e=await t.getFeed();switch(e.status){case s:case s:if(e.data){const t=e.data.map(e=>({...e,author_id:e.author_id||e.authorId||null}));this.sendAction("POSTS_LOAD_SUCCESS",{posts:t})}else this.sendAction("POSTS_LOAD_FAIL",{error:"No posts data"});break;case 204:this.sendAction("POSTS_LOAD_FAIL",{error:"No more content"});break;case r:this.sendAction("USER_UNAUTHORIZED"),this.sendAction("POSTS_LOAD_FAIL",{error:"Not authenticated"});break;default:this.sendAction("POSTS_LOAD_FAIL",{error:e.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤"})}}async loadProfile(e){let n="/profile";e&&(n=`/user?id=${e}`);const i=await t.get(n);switch(i.status){case s:if(i.data){const e={id:i.data.id,name:i.data.name,email:i.data.email,avatar:i.data.avatar||"/img/defaultAvatar.jpg",cover:i.data.cover||"/img/defaultCover.jpg",description:i.data.description,subscribersCount:i.data.subscribers_count||0,subscriptionsCount:i.data.subscriptions_count||0,postsCount:i.data.posts_count||0,isSubscribed:i.data.is_subscribed||!1},t=i.data.posts||[];this.sendAction("PROFILE_LOAD_SUCCESS",{profile:e,posts:t})}else this.sendAction("PROFILE_LOAD_FAIL",{error:"No profile data"});break;case 404:this.sendAction("PROFILE_LOAD_FAIL",{error:"–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"});break;case r:this.sendAction("USER_UNAUTHORIZED"),this.sendAction("PROFILE_LOAD_FAIL",{error:"Not authenticated"});break;default:this.sendAction("PROFILE_LOAD_FAIL",{error:i.message||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è"})}}async updateProfileDescription(e){const n=await t.post("/profile",{description:e});switch(n.status){case s:this.sendAction("PROFILE_UPDATE_DESCRIPTION_SUCCESS",{description:e});break;case r:this.sendAction("USER_UNAUTHORIZED"),this.sendAction("PROFILE_UPDATE_DESCRIPTION_FAIL",{error:"Not authenticated"});break;default:this.sendAction("PROFILE_UPDATE_DESCRIPTION_FAIL",{error:n.message||"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è"})}}};class i{constructor(){this.callbacks={}}register(e,t){this.callbacks[e]||(this.callbacks[e]=[]),this.callbacks[e].push(t)}dispatch(e,t){console.log(`[Dispatcher] Dispatching: ${e}`,t),n.handleAction(e,t),(this.callbacks[e]||[]).forEach(s=>{try{s(t)}catch(t){console.error(`Error in callback for ${e}:`,t)}})}unregister(e,t){this.callbacks[e]&&(this.callbacks[e]=this.callbacks[e].filter(e=>e!==t))}}const o=new i;new i;let a=null;class l{constructor({user:e,menuItems:t}){this.user=e,this.menuItems=t||[{key:"bookmarks",icon:"/img/icons/note_icon.svg",text:"–ß–µ—Ä–Ω–æ–≤–∏–∫–∏"},{key:"saved",icon:"/img/icons/bookmark.svg",text:"–ó–∞–∫–ª–∞–¥–∫–∏"},{key:"settings",icon:"/img/icons/settings_icon.svg",text:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏"},{key:"subscription",icon:"/img/icons/premium_icon.svg",text:"–ü–æ–¥–ø–∏—Å–∫–∞"},{key:"logout",icon:"/img/icons/exit_icon.svg",text:"–í—ã–π—Ç–∏"}]}async render(){const e=(await async function(){if(a)return a;const e=await fetch("/components/UserMenu/UserMenu.hbs"),t=await e.text();Handlebars.registerPartial("user-menu",Handlebars.compile(t));const s=await fetch("/components/MenuItem/MenuItem.hbs"),r=await s.text();Handlebars.registerPartial("menu-item",Handlebars.compile(r));const n=await fetch("/components/PopUpMenu/PopUpMenu.hbs"),i=await n.text();return a=Handlebars.compile(i),a}())({user:this.user,menuItems:this.menuItems}),t=document.createElement("div");t.innerHTML=e.trim();const s=t.firstElementChild;if(!s)throw new Error("Popup menu element not found");const r=s.querySelector(".user-menu");return r&&(r.style.cursor="pointer",r.addEventListener("click",e=>{e.preventDefault(),console.log("[PopUpMenu] –ö–ª–∏–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - –ø–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å"),s.parentNode&&s.remove(),window.history.pushState({},"","/profile"),window.dispatchEvent(new PopStateEvent("popstate"))})),s.querySelectorAll(".menu-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const r=e.dataset.key;console.log(`[PopUpMenu] –ö–ª–∏–∫ –ø–æ –ø—É–Ω–∫—Ç—É: ${r}`),s.parentNode&&s.remove(),"logout"===r&&async function(){console.log("–ü–æ–ø—ã—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Flux...");try{o.dispatch("LOGOUT_REQUEST")}catch(e){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:",e)}}()})}),s.addEventListener("click",e=>{e.stopPropagation()}),s}}class c{constructor(e){this.listeners=[],this.state=e,this.registerActions()}getState(){return{...this.state}}setState(e){this.state={...this.state,...e},this.emitChange()}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}emitChange(){this.listeners.forEach(e=>e())}registerAction(e,t){o.register(e,t)}}const d=new class extends c{constructor(){super({isLoggedIn:!1,user:null,isLoading:!1,error:null})}registerActions(){this.registerAction("LOGIN_REQUEST",()=>{this.setState({isLoading:!0,error:null})}),this.registerAction("USER_LOGIN_START",()=>{this.setState({isLoading:!0,error:null})}),this.registerAction("USER_LOGIN_SUCCESS",e=>{this.setState({isLoggedIn:!0,user:e.user,isLoading:!1,error:null})}),this.registerAction("USER_LOGIN_FAIL",e=>{this.setState({isLoggedIn:!1,user:null,isLoading:!1,error:e.error})}),this.registerAction("USER_LOGOUT",()=>{this.setState({isLoggedIn:!1,user:null,error:null})}),this.registerAction("USER_LOGIN_CHECKED",e=>{this.setState({isLoggedIn:!!e.user,user:e.user,isLoading:!1})})}};let h=null;class u{async render(){const e=(await async function(){if(h)return h;const e=await fetch("/components/Input/Input.hbs"),t=await e.text();Handlebars.registerPartial("input",Handlebars.compile(t));const s=await fetch("/components/FormButton/FormButton.hbs"),r=await s.text();Handlebars.registerPartial("button",Handlebars.compile(r));const n=await fetch("/components/LoginForm/LoginForm.hbs"),i=await n.text();return h=Handlebars.compile(i),h}())({}),t=document.createElement("div");t.innerHTML=e.trim();const s=t.firstElementChild;if(!s)throw new Error("Modal element not found");return s.addEventListener("click",e=>{e.target===s&&s.remove()}),s}getFormElement(e){return e.querySelector(".login-form__body")}getSignUpLink(e){return e.querySelector(".login-form__footer .link")}}let m=null;class p{async render(){const e=(await async function(){if(m)return m;const e=await fetch("/components/Input/Input.hbs"),t=await e.text();Handlebars.registerPartial("input",Handlebars.compile(t));const s=await fetch("/components/FormButton/FormButton.hbs"),r=await s.text();Handlebars.registerPartial("button",Handlebars.compile(r));const n=await fetch("/components/SignUpForm/SignUpForm.hbs"),i=await n.text();return m=Handlebars.compile(i),m}())({}),t=document.createElement("div");t.innerHTML=e.trim();const s=t.firstElementChild;if(!s)throw new Error("Modal element not found");return s.addEventListener("click",e=>{e.target===s&&s.remove()}),s}getFormElement(e){return e.querySelector(".registration-form__body")}getLoginLink(e){return e.querySelector(".registration-form__footer .link")}}const g=new class extends c{constructor(){super({isLoading:!1,error:null,fieldErrors:[],isSuccess:!1})}registerActions(){this.registerAction("SIGNUP_REQUEST",()=>{this.setState({isLoading:!0,error:null,fieldErrors:[],isSuccess:!1})}),this.registerAction("USER_SIGNUP_SUCCESS",()=>{this.setState({isLoading:!1,error:null,fieldErrors:[],isSuccess:!0})}),this.registerAction("USER_SIGNUP_FAIL",e=>{this.setState({isLoading:!1,error:e.error||null,fieldErrors:e.fieldErrors||[],isSuccess:!1})}),this.registerAction("SIGNUP_RESET",()=>{this.setState({isLoading:!1,error:null,fieldErrors:[],isSuccess:!1})})}};class f{constructor(){this.formElement=null,this.signUpForm=new p,this.boundStoreHandler=this.handleStoreChange.bind(this),this.init()}init(){g.addListener(this.boundStoreHandler)}async render(){return this.formElement=await this.signUpForm.render(),this.setupEventHandlers(),this.formElement}setupEventHandlers(){if(!this.formElement)return;const e=this.formElement.querySelector(".registration-form__body");if(e){const t=e.cloneNode(!0);e.parentNode?.replaceChild(t,e),t.addEventListener("submit",this.handleSubmit.bind(this)),this.setupPasswordToggles(t)}const t=this.formElement.querySelector(".registration-form__footer .link");t&&t.addEventListener("click",this.handleLoginClick.bind(this))}setupPasswordToggles(e){const t=e.querySelectorAll(".password-toggle"),s=e.querySelectorAll('input[type="password"]');t.forEach((e,t)=>{e.addEventListener("click",()=>{const r=s[t];"password"===r.type?(r.type="text",e.textContent="üôà"):(r.type="password",e.textContent="üôâ")})})}async handleSubmit(e){if(e.preventDefault(),!this.formElement)return;const t=this.formElement.querySelector(".registration-form__body"),s=new FormData(t),r=s.get("username"),n=s.get("email")?.trim(),i=s.get("password"),a=s.get("confirmPassword");this.clearErrors(t);const l=[];r?(r.length<4||/\s/.test(r))&&l.push({field:"username",message:"–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 4 —Å–∏–º–≤–æ–ª–æ–≤ –∏ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤"}):l.push({field:"username",message:"–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"}),n?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)||l.push({field:"email",message:"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email"}):l.push({field:"email",message:"Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}),i?(i.length<4||/\s/.test(i))&&l.push({field:"password",message:"–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 4 —Å–∏–º–≤–æ–ª–æ–≤ –∏ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤"}):l.push({field:"password",message:"–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}),a?i!==a&&l.push({field:"confirmPassword",message:"–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç"}):l.push({field:"confirmPassword",message:"–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"}),l.length>0?this.showFieldErrors(t,l):o.dispatch("SIGNUP_REQUEST",{name:r,email:n,password:i})}handleStoreChange(){const e=g.getState();if(e.error&&this.formElement){const t=this.formElement.querySelector(".registration-form__body");this.showFieldErrors(t,[{field:"email",message:e.error}])}if(e.fieldErrors&&this.formElement){const t=this.formElement.querySelector(".registration-form__body");this.showFieldErrors(t,e.fieldErrors)}e.isSuccess&&this.formElement&&(this.destroy(),window.location.reload())}showFieldErrors(e,t){t.forEach(({field:t,message:s})=>{const r=e.querySelector(`input[name="${t}"]`);if(!r)return;r.classList.add("error");const n=document.createElement("div");n.className="field-error",n.textContent=s;const i=r.closest(".input-wrapper");i?i.parentNode.insertBefore(n,i.nextSibling):r.parentNode.insertBefore(n,r.nextSibling)})}showGlobalError(e,t){const s=document.createElement("div");s.className="global-error",s.textContent=t,e.appendChild(s)}clearErrors(e){e.querySelectorAll(".form__input").forEach(e=>{e.classList.remove("error")}),e.querySelectorAll(".field-error, .global-error").forEach(e=>e.remove())}handleLoginClick(e){e.preventDefault(),this.destroy(),(new E).render().then(e=>{document.body.appendChild(e)})}destroy(){g.removeListener(this.boundStoreHandler),this.formElement&&this.formElement.parentNode&&this.formElement.remove()}}class E{constructor(){this.formElement=null,this.loginForm=new u,this.boundStoreHandler=this.handleStoreChange.bind(this),this.init()}init(){d.addListener(this.boundStoreHandler)}async render(){return this.formElement=await this.loginForm.render(),this.setupEventHandlers(),this.formElement}setupEventHandlers(){if(!this.formElement)return;const e=this.formElement.querySelector(".login-form__body");if(e){const t=e.cloneNode(!0);e.parentNode?.replaceChild(t,e),t.addEventListener("submit",this.handleSubmit.bind(this)),this.setupPasswordToggle(t)}const t=this.formElement.querySelector(".login-form__footer .link");t&&t.addEventListener("click",this.handleSignUpClick.bind(this))}setupPasswordToggle(e){const t=e.querySelector(".password-toggle"),s=e.querySelector('input[name="password"]');t&&s&&t.addEventListener("click",()=>{"password"===s.type?(s.type="text",t.textContent="üôà"):(s.type="password",t.textContent="üôâ")})}async handleSubmit(e){if(e.preventDefault(),!this.formElement)return;const t=this.formElement.querySelector(".login-form__body"),s=new FormData(t),r=s.get("email")?.trim(),n=s.get("password");console.log("Login attempt with:",{email:r,password:n}),this.clearErrors(t);const i=[];r?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)||i.push({field:"email",message:"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email"}):i.push({field:"email",message:"Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}),n?(n.length<4||/\s/.test(n))&&i.push({field:"password",message:"–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 4 —Å–∏–º–≤–æ–ª–æ–≤ –∏ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤"}):i.push({field:"password",message:"–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}),i.length>0?this.showFieldErrors(t,i):o.dispatch("LOGIN_REQUEST",{email:r,password:n})}handleStoreChange(){const e=d.getState();if(e.error&&this.formElement){const t=this.formElement.querySelector(".login-form__body");this.showFieldErrors(t,[{field:"email",message:e.error}])}e.isLoggedIn&&this.formElement&&(this.destroy(),window.location.reload())}showFieldErrors(e,t){t.forEach(({field:t,message:s})=>{const r=e.querySelector(`input[name="${t}"]`);if(!r)return;r.classList.add("error");const n=document.createElement("div");n.className="field-error",n.textContent=s;const i=r.closest(".input-wrapper");i?i.parentNode.insertBefore(n,i.nextSibling):r.parentNode.insertBefore(n,r.nextSibling)})}showGlobalError(e,t){const s=document.createElement("div");s.className="global-error",s.textContent=t,e.appendChild(s)}clearErrors(e){e.querySelectorAll(".form__input").forEach(e=>{e.classList.remove("error")}),e.querySelectorAll(".field-error, .global-error").forEach(e=>e.remove())}handleSignUpClick(e){e.preventDefault(),this.destroy(),(new f).render().then(e=>{document.body.appendChild(e)})}destroy(){d.removeListener(this.boundStoreHandler),this.formElement&&this.formElement.parentNode&&this.formElement.remove()}}let S=null,w=!1,b=null;class L{constructor(){this.headerElement=null,this.container=null,this.boundStoreHandler=this.handleStoreChange.bind(this),this.init()}init(){d.addListener(this.boundStoreHandler),o.dispatch("LOGIN_CHECK_REQUEST")}async render(e){e&&(this.container=e);const t=await async function(){return S||b||(w=!0,b=(async()=>{try{const[e,t,s,r]=await Promise.all([fetch("/components/Input/Input.hbs"),fetch("/components/FormButton/FormButton.hbs"),fetch("/components/Icon/Icon.hbs"),fetch("/components/Header/Header.hbs")]);if(!Handlebars.partials.input){const t=await e.text();Handlebars.registerPartial("input",Handlebars.compile(t))}if(!Handlebars.partials.button){const e=await t.text();Handlebars.registerPartial("button",Handlebars.compile(e))}if(!Handlebars.partials.icon){const e=await s.text();Handlebars.registerPartial("icon",Handlebars.compile(e))}const n=await r.text();return S=Handlebars.compile(n),S}catch(e){throw b=null,w=!1,e}})(),b)}(),s=d.getState(),r=t({isLoggedIn:s.isLoggedIn,user:s.user}),n=document.createElement("div");if(n.innerHTML=r.trim(),this.headerElement&&this.headerElement.parentNode&&this.headerElement.remove(),this.headerElement=n.firstElementChild,!this.headerElement)throw new Error("Header element not found");return this.setupEventHandlers(),this.headerElement}setupEventHandlers(){if(!this.headerElement)return;const e=d.getState(),t=this.headerElement.querySelector('[data-key="logo"]');t&&t.addEventListener("click",e=>{e.preventDefault(),console.log("Logo clicked - navigating to home"),this.navigateToHome()});const s=this.headerElement.querySelector('[data-key="user-menu"]');s&&e.isLoggedIn&&e.user&&s.addEventListener("click",async t=>{t.stopPropagation();const r=document.querySelector(".popUp-menu");if(r)return void r.remove();const n=new l({user:e.user,menuItems:[{key:"bookmarks",icon:"/img/icons/note_icon.svg",text:"–ß–µ—Ä–Ω–æ–≤–∏–∫–∏"},{key:"saved",icon:"/img/icons/bookmark.svg",text:"–ó–∞–∫–ª–∞–¥–∫–∏"},{key:"settings",icon:"/img/icons/settings_icon.svg",text:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏"},{key:"subscription",icon:"/img/icons/premium_icon.svg",text:"–ü–æ–¥–ø–∏—Å–∫–∞"},{key:"logout",icon:"/img/icons/exit_icon.svg",text:"–í—ã–π—Ç–∏"}]}),i=await n.render(),o=s.getBoundingClientRect();i.style.position="absolute",i.style.top=`${o.bottom+10}px`,i.style.right=window.innerWidth-o.right+"px",i.style.zIndex="1000",document.body.appendChild(i);const a=e=>{const t=e.target;i.contains(t)||t===s||(i.remove(),document.removeEventListener("click",a))};document.addEventListener("click",a)});const r=this.headerElement.querySelector('button[data-key="createPost"]');r&&(e.isLoggedIn?r.addEventListener("click",e=>{e.preventDefault(),console.log("Create post clicked - user is logged in")}):r.addEventListener("click",async e=>{e.preventDefault(),console.log("Create post clicked - showing login form"),await this.showLoginForm()}));const n=this.headerElement.querySelector('button[data-key="login"]');n&&!e.isLoggedIn&&n.addEventListener("click",async e=>{e.preventDefault(),console.log("Login button clicked"),await this.showLoginForm()})}navigateToHome(){console.log("Navigating to home page"),e.navigate("/")}async showLoginForm(){const e=new E,t=await e.render();document.body.appendChild(t)}async handleStoreChange(){if(console.log("Auth state changed - updating header"),this.container&&this.headerElement){const e=await this.render();this.container.appendChild(e)}}destroy(){d.removeListener(this.boundStoreHandler),this.headerElement&&this.headerElement.parentNode&&this.headerElement.remove()}}let y=null;const _=[{key:"fresh",icon:"/img/icons/Fresh_icon.svg",text:"–°–≤–µ–∂–µ–µ"},{key:"trends",icon:"/img/icons/trends_icon.svg",text:"–¢—Ä–µ–Ω–¥—ã"},{key:"feed",icon:"/img/icons/feed_icon.svg",text:"–õ–µ–Ω—Ç–∞"},{key:"messages",icon:"/img/icons/chat_icon.svg",text:"–°–æ–æ–±—â–µ–Ω–∏—è"}];let v="fresh";class A{async render(){const e=(await async function(){if(y)return y;const e=await fetch("/components/MenuItem/MenuItem.hbs"),t=await e.text();Handlebars.registerPartial("menu-item",Handlebars.compile(t));const s=await fetch("/components/SidebarMenu/SidebarMenu.hbs"),r=await s.text();return y=Handlebars.compile(r),y}())({menuItems:_}),t=document.createElement("div");t.innerHTML=e.trim();const s=t.firstElementChild;if(!s)throw new Error("Sidebar element not found");const r=e=>{v=e,s.querySelectorAll(".menu-item").forEach(t=>{t.classList.toggle("menu-item--active",t.dataset.key===e)})};return r("fresh"),s.querySelectorAll(".menu-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.dataset.key;console.log(`[Sidebar] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–¥–µ–ª: ${s}`),r(s)})}),s}}let C=null;const I=[{name:"–ê–∫–∫–∞—É–Ω—Ç 1",subtitle:"250,4k –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤",avatar:"/img/defaultAvatar.jpg"},{name:"–ê–∫–∫–∞—É–Ω—Ç 2",subtitle:"245,2k –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤",avatar:"/img/defaultAvatar.jpg"},{name:"–ê–∫–∫–∞—É–Ω—Ç 3",subtitle:"240,1k –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤",avatar:"/img/defaultAvatar.jpg"},{name:"–ê–∫–∫–∞—É–Ω—Ç 4",subtitle:"235,7k –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤",avatar:"/img/defaultAvatar.jpg"},{name:"–ê–∫–∫–∞—É–Ω—Ç 5",subtitle:"230,3k –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤",avatar:"/img/defaultAvatar.jpg"},{name:"–ê–∫–∫–∞—É–Ω—Ç 6",subtitle:"225,8k –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤",avatar:"/img/defaultAvatar.jpg"},{name:"–ê–∫–∫–∞—É–Ω—Ç 7",subtitle:"220,5k –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤",avatar:"/img/defaultAvatar.jpg"}];class k{constructor({bloggers:e=I}={}){this.bloggers=e}async render(){const e=(await async function(){if(C)return C;const e=await fetch("/components/UserMenu/UserMenu.hbs"),t=await e.text();Handlebars.registerPartial("user-menu",Handlebars.compile(t));const s=await fetch("/components/TopBloggers/TopBloggers.hbs"),r=await s.text();return C=Handlebars.compile(r),C}())({bloggers:this.bloggers.slice(0,7)}),t=document.createElement("div");t.innerHTML=e.trim();const s=t.firstElementChild;if(!s)throw new Error("Top bloggers element not found");return s}}let P=null;class R{constructor({user:e={name:"–ê–∫–∫–∞—É–Ω—Ç",subtitle:"—Ç–µ–º–∞",avatar:null,isSubscribed:!1},title:t="–ë–æ–ª—å—à–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞",text:s="–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –ø–æ–º–µ–Ω—å—à–µ",link:r="",linkText:n="—Å—Å—ã–ª–∫–∞",image:i=null,tags:o=["—Ç–µ–≥1","—Ç–µ–≥2","—Ç–µ–≥3"],commentsCount:a=123,repostsCount:l=42,viewsCount:c=42}){this.user=e,this.title=t,this.text=s,this.link=r,this.linkText=n,this.image=i,this.tags=o,this.commentsCount=a,this.repostsCount=l,this.viewsCount=c}async render(){const e=this.title.length>60?this.title.substring(0,60):null,t=this.text.length>200?this.text.substring(0,200):null,s=(await async function(){if(P)return P;const e=await fetch("/components/UserMenu/UserMenu.hbs"),t=await e.text();Handlebars.registerPartial("user-menu",Handlebars.compile(t));const s=await fetch("/components/Tag/Tag.hbs"),r=await s.text();Handlebars.registerPartial("tag",Handlebars.compile(r));const n=await fetch("/components/Icon/Icon.hbs"),i=await n.text();Handlebars.registerPartial("icon",Handlebars.compile(i));const o=await fetch("/components/PostCard/PostCard.hbs"),a=await o.text();return P=Handlebars.compile(a),P}())({user:this.user,title:this.title,titleTruncated:e,text:this.text,textTruncated:t,link:this.link,linkText:this.linkText,image:this.image,tags:this.tags,commentsCount:this.commentsCount,repostsCount:this.repostsCount,viewsCount:this.viewsCount}),r=document.createElement("div");r.innerHTML=s.trim();const n=r.firstElementChild;if(!n)throw new Error("Post card element not found");this.setupAuthorClickHandlers(n);const i=n.querySelector('[data-key="toggle-text"]'),o=n.querySelector(".post-card__text-preview"),a=n.querySelector(".post-card__text-full");if(i&&o&&a){let e=!1;i.addEventListener("click",t=>{t.preventDefault(),e=!e,o.hidden=e,a.hidden=!e,i.textContent=e?"–°–∫—Ä—ã—Ç—å":"–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é"})}const l=n.querySelector(".post-card__title");if(e&&l){let e=!1;l.style.cursor="pointer",l.title="–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤–µ—Å—å –∑–∞–≥–æ–ª–æ–≤–æ–∫",l.addEventListener("click",()=>{e=!e,e?(l.textContent=this.title,l.title="–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Å–≤–µ—Ä–Ω—É—Ç—å"):(l.innerHTML=`${this.title.substring(0,60)}...`,l.title="–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤–µ—Å—å –∑–∞–≥–æ–ª–æ–≤–æ–∫")})}return n}setupAuthorClickHandlers(e){const t=e.querySelector(".user-menu__avatar"),s=e.querySelector(".user-menu__name"),r=e.querySelector(".user-menu__subtitle"),n=e.querySelector(".user-menu__button"),i=e=>{e.preventDefault(),e.stopPropagation(),console.log(`[PostCard] –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ—Ä–∞: ${this.user.name}`,this.user.id);let t="/profile";this.user.id&&(t+=`?id=${this.user.id}`),window.history.pushState({},"",t),window.dispatchEvent(new PopStateEvent("popstate"))};t&&(t.style.cursor="pointer",t.addEventListener("click",i)),s&&(s.style.cursor="pointer",s.addEventListener("click",i)),r&&(r.style.cursor="pointer",r.addEventListener("click",i));const o=e.querySelector(".user-menu");o&&(o.style.cursor="pointer",o.addEventListener("click",e=>{n&&n.contains(e.target)||i(e)})),n&&n.addEventListener("click",e=>{e.stopPropagation()})}}const T=new class extends c{constructor(){super({posts:[],isLoading:!1,error:null,hasMore:!0})}registerActions(){this.registerAction("POSTS_LOAD_START",()=>{this.setState({isLoading:!0,error:null})}),this.registerAction("POSTS_LOAD_SUCCESS",e=>{this.setState({posts:[...this.state.posts,...e.posts],isLoading:!1,hasMore:e.posts.length>0})}),this.registerAction("POSTS_LOAD_FAIL",e=>{this.setState({isLoading:!1,error:e.error})}),this.registerAction("POSTS_CLEAR",()=>{this.setState({posts:[],error:null})})}};class U{constructor(){this.feedWrapper=null,this.sentinel=null,this.observer=null,this.virtualPostIndex=0,this.allPosts=[],this.boundStoreHandler=this.handleStoreChange.bind(this),this.initStoreListener()}initStoreListener(){T.addListener(this.boundStoreHandler)}async init(e){if(this.feedWrapper=e||document.getElementById("feed-wrapper"),!this.feedWrapper)throw new Error("Feed wrapper not found");this.setupInfiniteScroll(),o.dispatch("POSTS_LOAD_REQUEST")}setupInfiniteScroll(){this.feedWrapper&&(this.sentinel=document.createElement("div"),this.sentinel.style.height="20px",this.sentinel.className="scroll-sentinel",this.feedWrapper.appendChild(this.sentinel),this.observer=new IntersectionObserver(e=>{e[0].isIntersecting&&this.allPosts.length>0&&this.renderNextPosts()},{rootMargin:"100px"}),this.sentinel&&this.observer.observe(this.sentinel))}handleStoreChange(){const e=T.getState();e.posts.length>0&&(this.allPosts=e.posts,this.renderNextPosts()),e.error&&this.showError(e.error)}transformPost(e){return{user:{name:e.author_name||"–ê–Ω–æ–Ω–∏–º",subtitle:"–ë–ª–æ–≥",avatar:e.author_avatar||"/img/LogoMain.svg",isSubscribed:!1,id:e.author_id},title:e.title||"",text:e.content||"",image:e.image?.trim()||"",tags:["—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏","–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ"],commentsCount:12,repostsCount:4,viewsCount:1100}}async renderNextPosts(){if(!this.feedWrapper||0===this.allPosts.length)return;const e=document.createDocumentFragment();for(let t=0;t<3;t++){this.virtualPostIndex>=this.allPosts.length&&(this.virtualPostIndex=0);const t=this.allPosts[this.virtualPostIndex],s=this.transformPost(t);try{const t=new R(s),r=await t.render();e.appendChild(r)}catch(e){console.error("Error rendering post:",e)}this.virtualPostIndex++}this.sentinel?this.feedWrapper.insertBefore(e,this.sentinel):this.feedWrapper.appendChild(e)}showError(e){if(!this.feedWrapper)return;this.feedWrapper.innerHTML="";const t=document.createElement("div");t.className="feed-error",t.textContent=e,this.feedWrapper.appendChild(t)}destroy(){T.removeListener(this.boundStoreHandler),this.observer&&this.sentinel&&this.observer.unobserve(this.sentinel),this.feedWrapper=null,this.sentinel=null}}class x{constructor(){this.feedWrapper=null,this.headerInstance=new L,this.postsView=new U}async render(){const e=document.createElement("div"),t=document.createElement("header"),s=await this.headerInstance.render(t);t.appendChild(s),e.appendChild(t);const r=document.createElement("div");r.className="content-layout",e.appendChild(r);const n=document.createElement("aside");n.className="sidebar-left";const i=new A,o=await i.render();n.appendChild(o);const a=document.createElement("main");a.className="main-content",this.feedWrapper=document.createElement("div"),this.feedWrapper.className="feed",this.feedWrapper.id="feed-wrapper",a.appendChild(this.feedWrapper);const l=document.createElement("aside");l.className="sidebar-right";const c=new k,d=await c.render();l.appendChild(d),r.appendChild(n),r.appendChild(a),r.appendChild(l);try{await this.postsView.init(this.feedWrapper),console.log("PostsView initialized successfully")}catch(e){console.error("Failed to initialize PostsView:",e);const t=document.createElement("div");t.className="feed-error",t.textContent="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–µ–Ω—Ç—É –ø–æ—Å—Ç–æ–≤",this.feedWrapper&&this.feedWrapper.appendChild(t)}return e}destroy(){this.headerInstance.destroy(),this.postsView.destroy()}}let H=null;class O{constructor(e){this.props=e}async render(){const e=(await async function(){if(H)return H;const e=await fetch("/components/PostCard/PostCard.hbs");if(e.ok){const t=await e.text();Handlebars.registerPartial("post-card",Handlebars.compile(t))}Handlebars.registerHelper("eq",(e,t)=>e===t);const t=await fetch("/components/Profile/Profile.hbs"),s=await t.text();return H=Handlebars.compile(s),H}())(this.props),t=document.createElement("div");t.innerHTML=e.trim();const s=t.firstElementChild;if(!s)throw new Error("Profile element not found");return s}}const N=new class extends c{constructor(){super({profile:null,posts:[],comments:[],activeTab:"posts",isLoading:!1,error:null})}registerActions(){this.registerAction("PROFILE_LOAD_REQUEST",()=>{this.setState({isLoading:!0,error:null})}),this.registerAction("PROFILE_LOAD_SUCCESS",e=>{this.setState({profile:e.profile,posts:e.posts,isLoading:!1,error:null})}),this.registerAction("PROFILE_LOAD_FAIL",e=>{this.setState({isLoading:!1,error:e.error})}),this.registerAction("PROFILE_CHANGE_TAB",e=>{this.setState({activeTab:e.tab})}),this.registerAction("PROFILE_UPDATE_DESCRIPTION_REQUEST",()=>{this.setState({isLoading:!0,error:null})}),this.registerAction("PROFILE_UPDATE_DESCRIPTION_SUCCESS",e=>{this.state.profile&&this.setState({profile:{...this.state.profile,description:e.description},isLoading:!1,error:null})}),this.registerAction("PROFILE_UPDATE_DESCRIPTION_FAIL",e=>{this.setState({isLoading:!1,error:e.error})})}};class F{constructor(e,t){if(this.sidebarMenu=null,this.topBloggers=null,this.pageWrapper=null,this.container=e,this.headerInstance=new L,t&&t.id)this.userId=parseInt(t.id);else{const e=new URLSearchParams(window.location.search).get("id");e&&(this.userId=parseInt(e))}this.boundStoreHandler=this.handleStoreChange.bind(this),this.boundLoginStoreHandler=this.handleLoginStoreChange.bind(this)}async render(){return N.addListener(this.boundStoreHandler),d.addListener(this.boundLoginStoreHandler),o.dispatch("PROFILE_LOAD_REQUEST",{userId:this.userId}),await this.renderFullPage(),this.pageWrapper}async renderFullPage(){this.container.innerHTML="",this.pageWrapper=document.createElement("div");const e=document.createElement("header"),t=await this.headerInstance.render(e);e.appendChild(t),this.pageWrapper.appendChild(e);const s=document.createElement("div");s.className="content-layout";const r=document.createElement("aside");r.className="sidebar-left",this.sidebarMenu=new A;const n=await this.sidebarMenu.render();r.appendChild(n);const i=document.createElement("main");i.className="main-content";const o=await this.renderProfileContent();i.appendChild(o);const a=document.createElement("aside");a.className="sidebar-right",this.topBloggers=new k;const l=await this.topBloggers.render();a.appendChild(l),s.appendChild(r),s.appendChild(i),s.appendChild(a),this.pageWrapper.appendChild(s),this.container.appendChild(this.pageWrapper)}async renderProfileContent(){const e=N.getState(),t=new O({profile:e.profile,posts:e.posts,activeTab:e.activeTab,isLoading:e.isLoading,error:e.error}),s=await t.render();return this.attachEventListeners(s),s}handleStoreChange(){const e=this.container.querySelector(".main-content");e&&this.renderProfileContent().then(t=>{e.innerHTML="",e.appendChild(t)})}handleLoginStoreChange(){d.getState().isLoggedIn||e.navigate("/")}attachEventListeners(e){e.querySelectorAll("[data-tab]").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.tab;"posts"!==t&&"comments"!==t||o.dispatch("PROFILE_CHANGE_TAB",{tab:t})})});const t=e.querySelector(".profile__edit-btn");t&&t.addEventListener("click",()=>{this.editDescription()});const s=e.querySelector(".profile__description-placeholder");s&&s.addEventListener("click",()=>{this.editDescription()})}editDescription(){const e=N.getState();if(!e.profile)return;const t=prompt("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:",e.profile.description||"");null!==t&&o.dispatch("PROFILE_UPDATE_DESCRIPTION_REQUEST",{description:t})}destroy(){N.removeListener(this.boundStoreHandler),d.removeListener(this.boundLoginStoreHandler),this.headerInstance.destroy()}}(async function(){e.addRoute("/",x,"Mindleak - –ì–ª–∞–≤–Ω–∞—è"),e.addRoute("/profile",F,"Mindleak - –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"),e.addRoute("/user",F,"Mindleak - –ü—Ä–æ—Ñ–∏–ª—å"),e.init(),console.log("App initialized with routing")})().catch(console.error)})();